doctype html
html
  head
    title Formulario de Evolución del Paciente
    link(href="https://cdn.lineicons.com/4.0/lineicons.css", rel="stylesheet")
    link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css", rel="stylesheet")
    link(rel="stylesheet" href="css/styles.css")
    script(src="/js/frontConsulta.js")
    style.
      .datos-paciente {
        cursor: default; // Cambia el cursor a default
        margin-top: 20px; // Separación exterior superior
      }
  body
    .container-fluid(style="background-image: url('images/background_modulos.png'); background-size: cover; background-attachment: fixed; min-height: 100vh;")
      .row.justify-content-center
        .col-md-2(style="width: 200px;")
          include sidebar.pug

        .col-md-9
          .bg-light.p-4.rounded(style="margin-bottom: 20px; margin: 15px; opacity: 0.85;")
            .d-flex.align-items-center
              h3(style="margin: 0;") Bienvenido perri: #{medico}
              h3(style="margin: 0;") Consulta actual
              .mx-auto

            // Datos del Paciente
            if turno
              .card.mb-4.custom-bg.datos-paciente 
                .card-body.no-hover
                  .row
                    .col-md-6
                      h2.text-center Datos del Paciente
                      .text-center
                        p Nombre: #{turno.nombre}
                        p Apellido: #{turno.apellido}
                        p DNI: #{turno.dni_paciente}
                        p Motivo consulta: #{turno.motivo_consulta}
                    .col-md-6
                      h2.text-center Última visita
                      .text-center
                        if ultimoTurno
                          - var fecha = new Date(ultimoTurno.fecha);
                          - var dia = String(fecha.getDate()).padStart(2, '0');
                          - var mes = String(fecha.getMonth() + 1).padStart(2, '0'); // Los meses son 0-indexed
                          - var anio = fecha.getFullYear();
                          p Fecha: #{dia}-#{mes}-#{anio}
                          p Resumen: #{ultimoTurno.resumen_diagnostico}.
                          a.btn-hce.mt-3(href="/hce") Ir a HCE del paciente
                        else
                          p Esta es la primera visita del paciente
            else
              p No se encontraron datos del paciente.

            // Formulario de Evolución
            .col-md-12.mt-5

              //Evolucion ===============================================================
              h3.text-center Formulario de Evolución
              form(action="/submit" method="POST")
                .mb-3
                  label(for="template", class="form-label") Template evolución:
                  select#template.form-select(name="template")
                      option(value="") Seleccionar template
                      each t in templates
                          option(value=t.id_template data-contenido=t.contenido_template) #{t.nombre_template}
                .mb-3
                  label(for="evolucion", class="form-label") Evolución:
                  textarea#evolucion.form-control(name="evolucion" placeholder="Describir evolución del paciente" rows="3") 
                
                //Diagnostico==========================================================
                h3.text-center Diagnóstico
                div#diagnosticosContainer(class="diagnostico-item", style="display: block;")
                  .mb-3
                    label(for="diagnostico", class="form-label") Diagnóstico:
                    textarea#diagnostico.form-control(name="diagnostico" placeholder="Ingresar diagnóstico" rows="3")
  
                  .mb-3
                      label(for="estadoDiagnostico", class="form-label") Estado del Diagnóstico:
                      select#estadoDiagnostico.form-select(name="estadoDiagnostico")
                          option(value="") Seleccionar
                          option(value="Preliminar") Preliminar
                          option(value="Confirmado") Confirmado
                  // Botón para agregar otro diagnóstico
                button.btn.btn-secondary.mt-3(type="button", id="addDiagnosticoButton") + Agregar otro diagnóstico


                //Alergias ====================================================
                h3.text-center Alergias
                button.btn.btn-secondary(type="button" onclick="toggleSection('alergiasContainer')") Mostrar/Ocultar Alergias
                div#alergiasContainer(style="display: none;")
                  .row.justify-content-center
                    .col-12.col-md-6
                      .d-flex.align-items-center.mb-3.justify-content-center
                        label(for="inicioAlergia", class="form-label me-2") Inicio:
                        input#inicioAlergia(type="date" name="inicioAlergia" class="form-control" style="width: 180px;")
                      
                    .col-12.col-md-6
                      .d-flex.align-items-center.mb-3.justify-content-center
                        label(for="finAlergia", class="form-label me-2") Fin:
                        input#finAlergia(type="date" name="finAlergia" class="form-control" style="width: 180px;")

                  .mb-3
                    label(for="alergia", class="form-label") Alergias:
                    textarea#alergia.form-control(name="alergia" placeholder="Ingresar alergia" rows="3")

                  .mb-3
                      label(for="estadoAlergia", class="form-label") Nivel de alergia:
                      select#estadoAlergia.form-select(name="estadoAlergia")
                          option(value="") Seleccionar
                          option(value="Normal") Normal
                          option(value="Leve") Leve
                          option(value="Alta") Alta
                // Antecedentes ===============================================
                h3.text-center Antecedentes Patológicos
                button.btn.btn-secondary(type="button" onclick="toggleSection('antecedentesContainer')") Mostrar/Ocultar Antecedentes
                div#antecedentesContainer(style="display: none;")
                  .row.justify-content-center
                    .col-12.col-md-6
                      .d-flex.align-items-center.mb-3.justify-content-center
                        label(for="inicioAntecedentes", class="form-label me-2") Inicio:
                        input#inicioAntecedentes(type="date" name="inicioAntecedentes" class="form-control" style="width: 180px;")
                    
                    .col-12.col-md-6
                      .d-flex.align-items-center.mb-3.justify-content-center
                        label(for="finAntecedentes", class="form-label me-2") Fin:
                        input#finAntecedentes(type="date" name="finAntecedentes" class="form-control" style="width: 180px;")
                    
                  .mb-3
                    input#antecedentes.form-control(type="text" name="antecedentes" placeholder="Ingresar antecedentes")

                // Habitos ===============================================
                h3.text-center Hábitos
                button.btn.btn-secondary(type="button" onclick="toggleSection('habitosContainer')") Mostrar/Ocultar Hábitos
                div#habitosContainer(style="display: none;")
                  .row.justify-content-center
                    .col-12.col-md-6
                      .d-flex.align-items-center.mb-3.justify-content-center
                        label(for="inicioHabitos", class="form-label me-2") Inicio:
                        input#inicioHabitos(type="date" name="inicioHabitos" class="form-control" style="width: 180px;")
                    
                    .col-12.col-md-6
                      .d-flex.align-items-center.mb-3.justify-content-center
                        label(for="finHabitos", class="form-label me-2") Fin:
                        input#finHabitos(type="date" name="finHabitos" class="form-control" style="width: 180px;")
                    
                  .mb-3
                    input#habitos.form-control(type="text" name="habitos" placeholder="Ingresar hábitos")

                // Medicamentos ===============================================
                h3.text-center Medicamentos
                button.btn.btn-secondary(type="button" onclick="toggleSection('medicamentoContainer')") Mostrar/Ocultar Medicamentos
                div#medicamentoContainer(style="display: none;")
                  .mb-3
                    label(for="medicamento", class="form-label") Seleccionar medicamento:
                    select#medicamento.form-select(name="medicamento")
                      option(value="") Seleccionar medicamento
                      each m in medicamentos
                        option(value=m.id_medicamento) #{m.nombre_medicamento}

                button#guardarBoton(type="submit", class="btn btn-primary") Guardar

                
                script.
                  window.turno = !{JSON.stringify(turno)}; 
                  console.log('Datos de turnos iniciales:', window.turno);

                //Este script es para togglea entre las secciones que se ocultan
                script.
                  function toggleSection(id) {
                    const section = document.getElementById(id);
                    if (section.style.display === "none" || section.style.display === "") {
                        section.style.display = "block";
                    } else {
                        section.style.display = "none";
                    }
                  }